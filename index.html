<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IPS QR Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <style>
        .form-label {
            font-weight: bold;
        }
        [readonly] {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body class="p-4">
<div class="container">
    <h1>Plaćanje IPS QR kodom</h1>
    <div class="bg-light p-3 mb-3">
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="mb-3">
                    <label for="platilac" class="form-label">Platilac</label>
                    <input type="text" id="platilac" class="form-control" maxlength="70">
                </div>
                <div class="mb-3">
                    <label for="svrha" class="form-label">Svrha uplate</label>
                    <input type="text" id="svrha" class="form-control" maxlength="100">
                </div>
                <div class="mb-3">
                    <label for="primalac" class="form-label">Primalac</label>
                    <input type="text" id="primalac" class="form-control" maxlength="70">
                </div>
            </div>
            <div class="col-md-5 mb-3">
                <div class="mb-3">
                    <div class="row">
                        <div class="col-3">
                            <label for="sifra" class="form-label text-nowrap">Šifra plaćanja</label>
                            <input type="number" id="sifra" class="form-control" min="200" max="299">
                        </div>
                        <div class="col-3">
                            <label for="valuta" class="form-label">Valuta</label>
                            <input type="text" id="valuta" class="form-control" value="RSD" readonly>
                        </div>
                        <div class="col-6">
                            <label for="iznos" class="form-label">Iznos</label>
                            <input type="number" id="iznos" class="form-control" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="racun" class="form-label">Račun primaoca</label>
                    <input type="text" id="racun" class="form-control" pattern="\d{18}" maxlength="30">
                </div>
                <div class="mb-3">
                    <div class="row">
                        <div class="col-4">
                            <label for="model" class="form-label">Broj modela</label>
                            <input type="text" id="model" class="form-control" maxlength="2" pattern="\d{2}">
                        </div>
                        <div class="col-8">
                            <label for="poziv" class="form-label">Poziv na broj (odobrenje)</label>
                            <input type="text" id="poziv" class="form-control" maxlength="20">
                        </div>
                    </div>
                </div>
            </div>
            <div class="col text-center">
                <canvas id="qr" class="w-100 d-none"></canvas>
                <textarea id="ipsText" class="form-control" rows="5"></textarea>
            </div>
        </div>
    </div>
</div>
<script>
    const textarea = document.getElementById('ipsText');
    const qr = new QRious({
      element: document.getElementById('qr'),
      size: 256,
      value: ''
    });

    function updateQR(text) {
      qr.value = text;
    }

    function updateURL(text) {
      const url = new URL(window.location);
      url.searchParams.set('ips', text);
      history.replaceState(null, '', url);
    }

    function decodeParam(text) {
      try {
        return decodeURIComponent(text);
      } catch {
        return '';
      }
    }

    // Load from URL or use fallback test data
    const urlParam = new URLSearchParams(window.location.search).get('ips');
    const initialText = urlParam ? decodeParam(urlParam) :
      'K:PR|V:01|C:1|R:160000000123456789|N:MOJA FIRMA DOO|I:RSD1234.56|S:Račun za usluge';

    textarea.value = initialText;
    function parseIPS(text) {
      const parts = text.split('|');
      const data = {};
      parts.forEach(p => {
        const [key, ...rest] = p.split(':');
        data[key] = rest.join(':');
      });
      return data;
    }

    function populateFields(data) {
      if (data.P) document.getElementById('platilac').value = data.P;
      if (data.S) document.getElementById('svrha').value = data.S;
      if (data.N) document.getElementById('primalac').value = data.N;
      if (data.SF) document.getElementById('sifra').value = data.SF;
      if (data.I) {
        const match = data.I.match(/^([A-Z]{3})([\d.,]+)$/);
        if (match) {
          document.getElementById('valuta').value = match[1];
          document.getElementById('iznos').value = match[2].replace(',', '.');
        }
      }
      if (data.R) document.getElementById('racun').value = data.R;
      if (data.RO) {
        const match = data.RO.match(/^(\d{2})(.+)$/);
        if (match) {
          document.getElementById('model').value = match[1];
          document.getElementById('poziv').value = match[2];
        }
      }
    }

    const parsed = parseIPS(initialText);
    populateFields(parsed);
    onAnyInputChange();

    updateQR(initialText);

    function collectData() {
      const data = {
        K: 'PR',
        V: '01',
        C: '1'
      };
      const platilac = document.getElementById('platilac').value.trim();
      if (platilac) data.P = platilac;

      const svrha = document.getElementById('svrha').value.replace(/\s+/g, ' ').trim();
      if (svrha) data.S = svrha;

      const primalac = document.getElementById('primalac').value.trim();
      if (primalac) data.N = primalac;

      const sifra = document.getElementById('sifra').value.trim();
      if (sifra) data.SF = sifra;

      const valuta = document.getElementById('valuta').value.trim();
      const iznosRaw = document.getElementById('iznos').value.trim();
      const iznosNum = parseFloat(iznosRaw.replace(',', '.'));
      if (!isNaN(iznosNum) && valuta) {
        const formatted = iznosNum.toFixed(2).replace('.', ',');
        data.I = valuta + formatted;
      }

      const racunRaw = document.getElementById('racun').value;
      const racun = racunRaw.replace(/[\s-]/g, '');

      data.R = racun;

      const model = document.getElementById('model').value.trim();
      const poziv = document.getElementById('poziv').value.trim();
      if (model && poziv) data.RO = model + poziv;

      return data;
    }

    function buildIPS(data) {
      return ['K', 'V', 'C', 'R', 'N', 'I', 'SF', 'S', 'P', 'RO']
        .filter(key => data[key])
        .map(key => `${key}:${data[key]}`)
        .join('|');
    }

    function isValidModel97(account, model) {
      const digitsOnly = account.replace(/\D/g, '');
      if (digitsOnly.length !== 18) return false;
      if (model !== '97') return true;
      const rearranged = digitsOnly.slice(5) + digitsOnly.slice(0, 5) + '00';
      try {
        return BigInt(rearranged) % 97n === 1n;
      } catch {
        return false;
      }
    }

    function onAnyInputChange() {
      const racunRaw = document.getElementById('racun').value;
      const racun = racunRaw.replace(/[\s-]/g, '');
      const racunInput = document.getElementById('racun');
      const model = document.getElementById('model').value.trim();
      if (!isValidModel97(racun, model)) {
        racunInput.classList.add('is-invalid');
        qr.element.classList.add('d-none');
      } else {
        racunInput.classList.remove('is-invalid');
        qr.element.classList.remove('d-none');
      }
      const data = collectData();
      const text = buildIPS(data);
      textarea.value = text;
      updateQR(text);
      updateURL(encodeURIComponent(text));
    }

    const inputIds = ['platilac', 'svrha', 'primalac', 'sifra', 'valuta', 'iznos', 'racun', 'model', 'poziv'];
    inputIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', onAnyInputChange);
    });

    textarea.addEventListener('input', () => {
      const value = textarea.value;
      updateQR(value);
      updateURL(encodeURIComponent(value));
    });
</script>
</body>
</html>
